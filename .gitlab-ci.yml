# GitLab CI pipeline to build and push a Docker image to Docker Hub
#
# Required CI/CD variables (Settings > CI/CD > Variables):
# - DOCKERHUB_USERNAME: your Docker Hub username
# - DOCKERHUB_TOKEN: a Docker Hub Access Token (recommended) or password
# - DOCKERHUB_REPO: full repository name on Docker Hub, e.g. "myuser/gopro-immich-uploader"
#
# Tagging strategy:
# - latest on default branch
# - version from a VERSION file on default branch
# - sha-<shortsha> on all commits

stages:
  - secret-detection
  - lint
  - build


variables:
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_DRIVER: overlay2
  SECRET_DETECTION_ENABLED: 'true'

secret_detection:
  stage: secret-detection
include:
  - template: Security/Secret-Detection.gitlab-ci.yml

.release-rules:
  rules:
    # Skip build on chore commits
    - if: '$CI_COMMIT_MESSAGE =~ /^chore:/'
      when: never
    # Run on default branch and merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

format-check:
  extends: .release-rules
  image: python:3.13-slim
  stage: lint
  before_script:
    - pip install --no-cache-dir -r requirements-dev.txt
  script:
    - ruff format --check .

lint:
  extends: .release-rules
  image: python:3.13-slim
  stage: lint
  before_script:
    - pip install --no-cache-dir -r requirements-dev.txt
  script:
    - ruff check .

type-check:
  extends: .release-rules
  image: python:3.13-slim
  stage: lint
  before_script:
    - pip install --no-cache-dir -r requirements.txt -r requirements-dev.txt
  script:
    - mypy gopro_immich_uploader'

build-and-push:
  extends: .release-rules
  image: docker:28.4.0
  services:
    - name: docker:28.4.0-dind
      command: ["--mtu=1460"]
  stage: build
  before_script:
    - apk add --no-cache bash
    - |
      if [ -z "$DOCKERHUB_USERNAME" ] || [ -z "$DOCKERHUB_TOKEN" ] || [ -z "$DOCKERHUB_REPO" ]; then
        echo "ERROR: DOCKERHUB_USERNAME, DOCKERHUB_TOKEN and DOCKERHUB_REPO variables must be set." >&2
        exit 1
      fi
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - ./ci/build_and_push.sh
  after_script:
    - docker logout
  artifacts:
    when: on_failure
    reports:
      dotenv: [] # keep minimal; no artifacts saved
