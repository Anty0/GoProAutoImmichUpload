# GitLab CI pipeline to build and push a Docker image to Docker Hub
#
# Required CI/CD variables (Settings > CI/CD > Variables):
# - DOCKERHUB_USERNAME: your Docker Hub username
# - DOCKERHUB_TOKEN: a Docker Hub Access Token (recommended) or password
# - DOCKERHUB_REPO: full repository name on Docker Hub, e.g. "myuser/gopro-immich-uploader"
#
# Tagging strategy:
# - latest on default branch
# - <git tag> on tagged commits
# - sha-<shortsha> on all commits

stages:
- secret-detection
- build

image: docker:27

services:
- name: docker:27-dind
  command: ["--mtu=1460"]

variables:
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_DRIVER: overlay2
  SECRET_DETECTION_ENABLED: 'true'

secret_detection:
  stage: secret-detection
include:
- template: Security/Secret-Detection.gitlab-ci.yml

build-and-push:
  stage: build
  rules:
    # Run on default branch, tags, and merge requests
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  before_script:
    - |
      if [ -z "$DOCKERHUB_USERNAME" ] || [ -z "$DOCKERHUB_TOKEN" ] || [ -z "$DOCKERHUB_REPO" ]; then
        echo "ERROR: DOCKERHUB_USERNAME, DOCKERHUB_TOKEN and DOCKERHUB_REPO variables must be set." >&2
        exit 1
      fi
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - ./ci/build-and-push.sh
  after_script:
    - docker logout
  artifacts:
    when: on_failure
    reports:
      dotenv: [] # keep minimal; no artifacts saved
